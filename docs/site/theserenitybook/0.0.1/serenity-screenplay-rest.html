<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Working with REST APIs using Serenity Screenplay :: The Serenity BDD Book</title>
    <meta name="generator" content="Antora 1.0.1">
    <link rel="stylesheet" href="../../_/css/site.css">
  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../..">The Serenity BDD Book</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <a class="navbar-item" href="https://github.com/serenity-bdd/serenity-core/issues">Issues</a>
        <a class="navbar-item" href="https://github.com/serenity-bdd/serenity-core">Source Code on Github</a>
        <a class="navbar-item" href="https://johnfergusonsmart.com/serenity-bdd-mentoring/">Serenity Support</a>
        <a class="navbar-item" href="https://serenitydojo.teachable.com">Serenity Online Training</a>

        <!-- <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Resources</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Resource A</a>
            <a class="navbar-item" href="#">Resource B</a>
            <a class="navbar-item" href="#">Resource C</a>
          </div>
        </div> -->
        <!-- <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div> -->
      </div>
    </div>
  </nav>
</header>
<div class="main-wrapper">
<div class="navigation-container" data-component="theserenitybook" data-version="0.0.1">
  <aside class="navigation" role="navigation">
    <div class="panels">
<div class="navigation-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">The Serenity Book</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Serenity BDD Fundamentals</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">Introduction to Serenity BDD</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="getting-started.html">Getting Started</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="first-steps.html">First Steps</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="step-libraries.html">Working with Step Libraries</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Testing Web Applications</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="angularjs.html">Testing AngularJS applications</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">The Screenplay Pattern</span>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="serenity-screenplay-rest.html">REST API Tesing with Screenplay</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Reporting and Living documentation</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="living-documentation.html">Living Documentation</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-toggle"></button>
    <span class="nav-text">Reference</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="glossary.adoc">Glossary</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="navigation-explore" data-panel="explore">
  <div class="context">
    <span class="title">The Serenity Book</span>
    <span class="version">0.0.1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">The Serenity Book</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">0.0.1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
  <main class="main" role="main">
<div class="toolbar" role="navigation">
  <button class="navigation-toggle"></button>
<nav class="crumbs" role="navigation" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="index.html">The Serenity Book</a></li>
    <li class="crumb">The Screenplay Pattern</li>
    <li class="crumb"><a href="serenity-screenplay-rest.html">REST API Tesing with Screenplay</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/serenity-bdd/the-serenity-book/edit/master/modules/ROOT/pages/serenity-screenplay-rest.adoc">Edit this Page</a></div>
</div>
<article class="doc">
<h1>Working with REST APIs using Serenity Screenplay</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The Screenplay pattern is an approach to writing automated acceptance tests that helps us write cleaner, more maintainable, more scalable automation code. A Screenplay test talks first and foremost about the tasks a user performs, in business language, rather than diving into the details about buttons, clicks and input fields. Focusing on the business tasks makes our tests more readable, more maintainable, and easier to scale.</p>
</div>
<div class="paragraph">
<p>Screenplay is often associated with UI testing. Interestingly, the name of the pattern is actually unrelated to screens or user interfaces; it comes from a theatre metaphor, where actors play roles on a stage following a predefined script (the "screenplay"), and was coined by Antony Marcano and Andy Palmer around 2015. The pattern itself goes back further than that, and has been around in various forms since it was first proposed by Antony Marcano in 2007.</p>
</div>
<div class="paragraph">
<p>But Screenplay is also a great fit for API or web service tests. In particular, Screenplay is ideal when we want to include API and UI activities in the same test. For example, we might have an API task to set up some test data, a UI task to illustrate how a user interacts with this data, then another API task to check the new state of the database.</p>
</div>
<div class="paragraph">
<p>You can get a taste of what REST API interactions using Serenity Screenplay look like here:</p>
</div>
<div class="listingblock">
<div class="title">WhenManagingUsers.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Test
public void list_all_users() {

    Actor sam = Actor.named("Sam the supervisor")
                     .whoCan(CallAnApi.at(theRestApiBaseUrl));

    sam.attemptsTo(
            Get.resource("/users")
    );

    sam.should(
            seeThatResponse("all the expected users should be returned",
                    response -&gt; response.statusCode(200)
                                        .body("data.first_name", hasItems("George", "Janet", "Emma")))
    );
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Serenity Screenplay uses <a href="http://rest-assured.io">Rest-Assured</a> to interact with rest endpoints, and to query the responses. Rest-Assured provides us with a simple but extremely powerful Java DSL that allows us to test and virtually any kind of REST end point. Its highly readable code is also an ideal fit for Screenplay.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setting_up_your_project"><a class="anchor" href="#_setting_up_your_project"></a>Setting up your project</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To test REST API services with Screenplay, you need to add the <code>serenity-screenplay-rest</code> dependency to your project. In Maven, add the following to the dependencies in your <code>pom.xml</code> file:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;net.serenity-bdd&lt;/groupId&gt;
    &lt;artifactId&gt;serenity-screenplay-rest&lt;/artifactId&gt;
    &lt;version&gt;${serenity.version}&lt;/version&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>And for Gradle, you can add the same dependency to your <code>build.gradle</code> file:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">testCompile "net.serenity-bdd:serenity-screenplay-rest:${serenityVersion}"</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_defining_a_base_uri"><a class="anchor" href="#_defining_a_base_uri"></a>Defining a base URI</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When you test a REST API, it is convenient to be able to use the same tests against different environments. You may want to run your tests against a server running on your local machine, against a QA server, or even against a production box. And you don&#8217;t want to have to change your tests whenever you test against a different environment.</p>
</div>
<div class="paragraph">
<p>For example, in this chapter, we will be demonstrating the features of <code>serenity-screenplay-rest</code> using the <a href="https://reqres.in">ResReq</a> application (see below). If you have a reliable internet connection, you can run your tests against the live ResReq server at <a href="https://reqres.in/api/" class="bare">https://reqres.in/api/</a>. Or if you are running the ResReq server locally, you would access endpoints at <a href="http://localhost:5000/api" class="bare">http://localhost:5000/api</a>.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">The ResReq test application</div>
<div class="paragraph">
<p>The <a href="https://reqres.in">ResReq</a> application is an open source application written by <a href="http://benhowdle.im/">Ben Howdle</a> that makes it easy to experiment with REST APIs. It is hosted on Digital Ocean, where you can access it online at <a href="https://reqres.in/api/" class="bare">https://reqres.in/api/</a>. Alternatively, you can also download the application from the project&#8217;s <a href="https://github.com/benhowdle89/reqres">repository on Github</a>, and run it locally. When you run the application on your own machine, the REST API will be available at <a href="http://localhost:5000/api" class="bare">http://localhost:5000/api</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_reading_from_the_serenity_config_file"><a class="anchor" href="#_reading_from_the_serenity_config_file"></a>Reading from the Serenity config file</h3>
<div class="paragraph">
<p>In Serenity BDD, you can define the base URL for your REST API directly in the <code>serenity.properties</code> or <code>serenity.conf</code> file for your project.
Here is an example from a <code>serenity.conf</code> file:</p>
</div>
<div class="listingblock">
<div class="title">serenity.conf</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">restapi {
      baseurl = "https://reqres.in/api"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Any test can read values from the Serenity configuration files simply by creating a field of type <code>EnvironmentVariables</code> in the test.
You can then fetch the property, and provide a default value to use if the property hasn&#8217;t been defined, as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">theRestApiBaseUrl = environmentVariables.optionalProperty("restapi.baseurl")
                                        .orElse("https://reqres.in/api");</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_setting_the_api_url_from_the_command_line"><a class="anchor" href="#_setting_the_api_url_from_the_command_line"></a>Setting the API Url from the command line</h3>
<div class="paragraph">
<p>You can override the default URL defined this way simply by providing a system property on the command line, like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mvn verify -Drestapi.baseurl=http://localhost:5000/api</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_the_base_api_url_in_maven"><a class="anchor" href="#_configuring_the_base_api_url_in_maven"></a>Configuring the base API URL in Maven</h3>
<div class="paragraph">
<p>If you are using Maven, a more convenient approach may be to use <a href="http://maven.apache.org/guides/introduction/introduction-to-profiles.html">Maven Profiles</a>.
In your <code>pom.xml</code> file, you define up different Maven profiles for each environment, and set the <code>restapi.baseurl</code> property accordingly:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;profiles&gt;
    &lt;profile&gt;
        &lt;id&gt;dev&lt;/id&gt;
        &lt;properties&gt;
            &lt;restapi.baseurl&gt;http://localhost:5000/api&lt;/restapi.baseurl&gt;
        &lt;/properties&gt;
    &lt;/profile&gt;
    &lt;profile&gt;
        &lt;id&gt;prod&lt;/id&gt;
        &lt;properties&gt;
            &lt;restapi.baseurl&gt;https://reqres.in/api&lt;/restapi.baseurl&gt;
        &lt;/properties&gt;
    &lt;/profile&gt;
&lt;/profiles&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For this to work properly, you also need to ensure that the <code>restapi.baseurl</code> is passed correctly to your tests.
You do this by using the <code>systemPropertyVariables</code> tag in the `maven-failsafe-plugin' configuration, as shown here:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;build&gt;
    &lt;plugins&gt;
        &lt;plugin&gt;
            &lt;artifactId&gt;maven-failsafe-plugin&lt;/artifactId&gt;
            &lt;version&gt;2.20&lt;/version&gt;
            &lt;configuration&gt;
                &lt;includes&gt;
                    &lt;include&gt;**/When*.java&lt;/include&gt;
                    &lt;include&gt;**/*Feature.java&lt;/include&gt;
                &lt;/includes&gt;
                &lt;systemPropertyVariables&gt;
                    &lt;restapi.baseurl&gt;${restapi.baseurl}&lt;/restapi.baseurl&gt;
                &lt;/systemPropertyVariables&gt;
            &lt;/configuration&gt;
            &lt;executions&gt;
                &lt;execution&gt;
                    &lt;goals&gt;
                        &lt;goal&gt;integration-test&lt;/goal&gt;
                        &lt;goal&gt;verify&lt;/goal&gt;
                    &lt;/goals&gt;
                &lt;/execution&gt;
            &lt;/executions&gt;
        &lt;/plugin&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can then run the tests with Maven using the <code>-P</code> option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ mvn verify -Pdev</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuring_the_actor_the_callanapi_ability"><a class="anchor" href="#_configuring_the_actor_the_callanapi_ability"></a>Configuring the actor - the CallAnApi ability</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In Screenplay, tests describe behaviour in terms of <em>actors</em>, who achieve their business goals by performing <em>tasks</em>.
These tasks usually involve <em>interacting</em> with the application in some way.
And to perform these tasks, we give the actors various <em>abilities</em>.</p>
</div>
<div class="paragraph">
<p>The <code>CallAnApi</code> ability gives actors the ability to interact with a REST web service using <a href="http://rest-assured.io">Rest-Assured</a>.
This includes both invoking REST end-points and querying the results.</p>
</div>
<div class="listingblock">
<div class="title">WhenManagingUsers.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">private String theRestApiBaseUrl;
private EnvironmentVariables environmentVariables; <i class="conum" data-value="1"></i><b>(1)</b>
private Actor sam; <i class="conum" data-value="2"></i><b>(2)</b>

@Before
public void configureBaseUrl() {
    theRestApiBaseUrl = environmentVariables.optionalProperty("restapi.baseurl") <i class="conum" data-value="3"></i><b>(3)</b>
                                                   .orElse("https://reqres.in/api");

    sam = Actor.named("Sam the supervisor").whoCan(CallAnApi.at(theRestApiBaseUrl)); <i class="conum" data-value="4"></i><b>(4)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Serenity properties - Serenity will instantiate this field automatically</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A Screenplay actor - this actor will be used in all our tests</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Here we fetch the REST API base url</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Then we create an actor with the ability to call REST end-points at the specified URL</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>CallAnApi</code> ability allows the actor to perform the bundled Serenity REST interaction classes. This include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Get.resource()</p>
</li>
<li>
<p>Post.to()</p>
</li>
<li>
<p>Put.to()</p>
</li>
<li>
<p>Delete.from()</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The simplest of these is <code>Get</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_get_interactions"><a class="anchor" href="#_get_interactions"></a>GET Interactions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In a REST API, GET requests are used to query a REST resource.
Let&#8217;s see how we can do this using Serenity Screenplay.</p>
</div>
<div class="sect2">
<h3 id="_simple_get_requests"><a class="anchor" href="#_simple_get_requests"></a>Simple GET requests</h3>
<div class="paragraph">
<p>In our demo application, the <code>/users</code> resource represents application users.
We can retrieve the details of a particular user by appending the user ID, like this: <code>/users/1</code>.
The structure of a user record is shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "data": {
    "id": 1,
    "first_name": "George",
    "last_name": "Bluth",
    "avatar": "https://s3.amazonaws.com/uifaces/faces/twitter/calebogden/128.jpg"
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Suppose we need to write a scenario that retrieves a particular user, and checks some of the user&#8217;s details, such as first_name and last_name.
Such a test might look like this:</p>
</div>
<div class="listingblock">
<div class="title">WhenManagingUsers.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Test
public void find_an_individual_user() {

    sam.attemptsTo(
            Get.resource("/users/1") <i class="conum" data-value="1"></i><b>(1)</b>
    );

    sam.should(
            seeThatResponse( "User details should be correct", <i class="conum" data-value="2"></i><b>(2)</b>
                    response -&gt; response.statusCode(200) <i class="conum" data-value="3"></i><b>(3)</b>
                                        .body("data.first_name", equalTo("George")) <i class="conum" data-value="4"></i><b>(4)</b>
                                        .body("data.last_name", equalTo("Bluth")) <i class="conum" data-value="5"></i><b>(5)</b>
            )
    );
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Sam performs a GET</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We check the response using the <code>seeThatResponse</code> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Did the call return a status code of 200?</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Is the first_name field 'George'?</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Is the last_name field 'Bluth'?</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As you can see, this code is fairly self-explanatory.
Like any other Screenplay test, we use the actor&#8217;s <code>attemptsTo()</code> method to perform the action we want to test.
In this case, we use the <code>Get</code> interaction class, which comes bundled with <code>serenity-screenplay-rest</code>.</p>
</div>
<div class="paragraph">
<p>Next we check the response using the <code>seeThatResponse</code> method.
This method takes a Lambda expression and allows us to access the full RestAssured API.
In particular, we can use <a href="http://static.javadoc.io/io.restassured/json-path/3.1.0/io/restassured/path/json/JsonPath.html">jsonPath</a> expressions to query the JSON structure we receive.</p>
</div>
</div>
<div class="sect2">
<h3 id="_retrieving_objects"><a class="anchor" href="#_retrieving_objects"></a>Retrieving objects</h3>
<div class="paragraph">
<p>Sometimes we need to fetch a value from a REST response, and keep it for use later on. RestAssured makes it relatively easy to convert a JSON structure to a Java object, which you can use later on in your tests.</p>
</div>
<div class="paragraph">
<p>For example, suppose we have a class like the one below, which corresponds to the user details returned by our endpoint:</p>
</div>
<div class="listingblock">
<div class="title">WhenManagingUsers.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package examples.screenplay.rest.model;

public class User {
    private String id;
    private String first_name;
    private String last_name;


    public User(String first_name, String last_name) {
        this.first_name = first_name;
        this.last_name = last_name;
    }

    public String getId() {
        return id;
    }

    public String getFirstName() {
        return first_name;
    }

    public String getLastName() {
        return last_name;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We could retrieve the user as an instance of this class by calling the <code>jsonPath().getObject()</code> method on the received response. This method will convert the JSON data on a given path to a corresponding Java structure:</p>
</div>
<div class="listingblock">
<div class="title">WhenManagingUsers.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Test
public void retrieve_an_element_from_the_json_structure() {

    sam.attemptsTo(
            Get.resource("/users/1")
    );

    User user = SerenityRest.lastResponse() <i class="conum" data-value="1"></i><b>(1)</b>
                            .jsonPath()
                            .getObject("data", User.class); <i class="conum" data-value="2"></i><b>(2)</b>

    assertThat(user.getFirstName()).isEqualTo("George");
    assertThat(user.getLastName()).isEqualTo("Bluth");

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retrieve the response returned by the previous RESRT call</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Convert the JSON entry in the <code>data</code> field to a <code>User</code></td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_retrieving_lists"><a class="anchor" href="#_retrieving_lists"></a>Retrieving lists</h3>
<div class="paragraph">
<p>Oftentimes we need to retrieve not a single item, but a list of items.
Retrieving a list is little different to retrieving a single item:</p>
</div>
<div class="listingblock">
<div class="title">WhenManagingUsers.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">sam.attemptsTo(
        Get.resource("/users") <i class="conum" data-value="1"></i><b>(1)</b>
);

sam.should(
        seeThatResponse("all the expected users should be returned",
                response -&gt; response.body("data.first_name", hasItems("George", "Janet", "Emma"))) <i class="conum" data-value="2"></i><b>(2)</b>
);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Retrieve all the users</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Check the list of user first names</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The difference happens when we query the results.
In this case, we use a jsonPath expression (<code>data.first_name</code>) that will return <em>all</em> of the first_name field values.
The Hamcrest matcher <code>hasItems</code> will compare the collection of first names that the jsonPath query returns, and check that it contains (at least) the names "George", "Janet" and "Emma".</p>
</div>
<div class="paragraph">
<p>But what if we want to capture the data we retrieve, rather than simply make an assertion about the contents?
We can do that using the <code>SerenityRest.lastResponse()</code> method, like this:</p>
</div>
<div class="listingblock">
<div class="title">WhenManagingUsers.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">List&lt;String&gt; userSurnames = SerenityRest.lastResponse().path("data.last_name"); <i class="conum" data-value="1"></i><b>(1)</b>
assertThat(userSurnames).contains("Bluth", "Weaver", "Wong");</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use a JsonPath expression to retrieve all the <code>last_name</code> values underneath the <code>data</code> entry.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We can also retrieve lists of objects, just as we retrieved a single <code>User</code> instance in the previous section.
Simply use the <code>jsonPath.getList()</code> method as shown below:</p>
</div>
<div class="listingblock">
<div class="title">WhenManagingUsers.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">List&lt;User&gt; users = SerenityRest.lastResponse()
                               .jsonPath()
                               .getList("data", User.class); <i class="conum" data-value="1"></i><b>(1)</b>

assertThat(users).hasSize(3);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Return a list of <code>User</code> instances</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_using_path_parameters"><a class="anchor" href="#_using_path_parameters"></a>Using Path Parameters</h3>
<div class="paragraph">
<p>In the previous example, we hard-coded the path element in the request.
For a more flexible approach, we can supply the path parameter when we submit the query:</p>
</div>
<div class="listingblock">
<div class="title">WhenManagingUsers.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">sam.attemptsTo(
        Get.resource("/users/{id}").with( request -&gt; request.pathParam("id", 1)) <i class="conum" data-value="1"></i><b>(1)</b>
);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Provide the user ID as a path parameter</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here we are using the <code>Get.resource(&#8230;&#8203;).with(&#8230;&#8203;)</code> structure to pass the RestAssured <code>RequestSpecification</code> object into a lambda expression.
Once again, this gives us access to all the richness of the RestAssert library</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_query_parameters"><a class="anchor" href="#_using_query_parameters"></a>Using Query Parameters</h3>
<div class="paragraph">
<p>Some REST APIs take query parameters as well as path parameters. Query parameters are commonly used to filter results or implement pagination. For example, we could get the second page of users from our <code>/users</code> API by using the <code>page</code> query parameter like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>/users?page=2</pre>
</div>
</div>
<div class="paragraph">
<p>In our test code, we use the <code>queryParam()</code> method to provide a value for the <code>page</code> parameter:</p>
</div>
<div class="listingblock">
<div class="title">WhenManagingUsers.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">sam.attemptsTo(
        Get.resource("/users").with( request -&gt; request.queryParam("page", 2)) <i class="conum" data-value="1"></i><b>(1)</b>
);

sam.should(
        seeThatResponse("All users on page 2 should be returned",
                response -&gt; response.body("data.first_name",
                                     hasItems("Eve", "Charles", "Tracey"))) <i class="conum" data-value="2"></i><b>(2)</b>
);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Return page 2 of the results</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_post_queries"><a class="anchor" href="#_post_queries"></a>Post queries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We can send POST requests to a REST end-point using the <code>Post</code> interaction class. Here is a simple example:</p>
</div>
<div class="listingblock">
<div class="title">WhenManagingUsers.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">sam.attemptsTo(
        Post.to("/users")
                .with(request -&gt; request.header("Content-Type", "application/json") <i class="conum" data-value="1"></i><b>(1)</b>
                                        .body("{\"firstName\": \"Sarah-Jane\",\"lastName\": \"Smith\"}") <i class="conum" data-value="2"></i><b>(2)</b>
                )
);

sam.should(
        seeThatResponse("The user should have been successfully added",
                        response -&gt; response.statusCode(201))
);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Specify the content type in the header</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Specify the request body</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Alternatively, we can post an object, letting RestAssured convert the object fields into JSON for us:</p>
</div>
<div class="listingblock">
<div class="title">WhenManagingUsers.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">User newUser = new User("Sarah-Jane", "Smith");

sam.attemptsTo(
        Post.to("/users")
                .with(request -&gt; request.header("Content-Type", "application/json")
                                        .body(newUser) <i class="conum" data-value="1"></i><b>(1)</b>
                )
);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Pass in an object rather than a JSON string</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_other_types_of_queries"><a class="anchor" href="#_other_types_of_queries"></a>Other types of queries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Other query types are similar to <code>GET</code> and <code>POST</code> queries.
For example, <code>PUT</code> requests are often used to update resources.
In the following example, we use a <code>PUT</code> request to update a user&#8217;s details:</p>
</div>
<div class="listingblock">
<div class="title">WhenManagingUsers.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">sam.attemptsTo(
        Put.to("/users")
                .with(request -&gt; request.header("Content-Type", "application/json")
                        .body("{\"firstName\": \"jack\",\"lastName\": \"smith\"}")
                )
);

sam.should(
        seeThatResponse(response -&gt; response.statusCode(200)
                                            .body("updatedAt", not(isEmptyString())))
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or you can delete a user using the <code>DELETE</code> query as shown here:</p>
</div>
<div class="listingblock">
<div class="title">WhenManagingUsers.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">sam.attemptsTo(
        Delete.from("/users/1")
);

sam.should(
        seeThatResponse(response -&gt; response.statusCode(204))
);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_higher_level_tasks"><a class="anchor" href="#_higher_level_tasks"></a>Higher level tasks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The interactions we have seen so far are readable but still quite low level.
Screenplay allows us to build higher level tasks that represent the business intent behind these interactions.</p>
</div>
<div class="paragraph">
<p>For example, you could define a task that encapsulates listing all users like this:</p>
</div>
<div class="listingblock">
<div class="title">UserTasks.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package examples.screenplay.rest.tasks;

import net.serenitybdd.screenplay.Task;
import net.serenitybdd.screenplay.rest.interactions.Get;

public class UserTasks {
    public static Task listAllUsers() {
        return Task.where("{0} lists all users",  <i class="conum" data-value="1"></i><b>(1)</b>
                Get.resource("/users") <i class="conum" data-value="2"></i><b>(2)</b>
        );
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define a task where the actor lists all the users</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This task is implemented using a <code>Get</code> interaction</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We can then use a static import to refactor our first test as follows:</p>
</div>
<div class="listingblock">
<div class="title">WhenManagingUsers.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">sam.attemptsTo(
        listAllUsers()
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a bit more flexibility, we can also write a custom <code>Task</code> class. For example, we could write a <code>FindAUser</code> task to find a user by ID:</p>
</div>
<div class="listingblock">
<div class="title">FindAUser.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package examples.screenplay.rest.tasks;

import net.serenitybdd.screenplay.Actor;
import net.serenitybdd.screenplay.Task;
import net.serenitybdd.screenplay.rest.interactions.Get;
import net.thucydides.core.annotations.Step;

import static net.serenitybdd.screenplay.Tasks.instrumented;

public class FindAUser implements Task{
    private final int id;

    public FindAUser(int id) {
        this.id = id;
    }

    public static FindAUser withId(int id) {
        return instrumented(FindAUser.class, id);
    }

    @Override
    @Step("{0} fetches the user with id #id")
    public &lt;T extends Actor&gt; void performAs(T actor) {
        actor.attemptsTo(
                Get.resource("/users/{id}")
                   .with(request -&gt; request.pathParam("id", id))
        );
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using this class, we could refactor our original class to read like this:</p>
</div>
<div class="listingblock">
<div class="title">WhenManagingUsers.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">sam.attemptsTo(
        FindAUser.withId(1)
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using tasks to encapsulate REST interactions results in a clear, layered reporting structure, that first describes what the user is doing, and they how they go about it. The test report for the previous scenario is shown here:</p>
</div>
<div id="fig-requirements-tab" class="imageblock">
<div class="content">
<img src="_images/find-a-user-by-id.png" alt="find a user by id">
</div>
<div class="title">Figure 1. Serenity living documentation for Screenplay and REST</div>
</div>
</div>
</div>
</article>
  </main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../_/js/site.js"></script>
<script src="../../_/js/vendor/highlight.js"></script>
<script>hljs.initHighlighting()</script>
  </body>
</html>
